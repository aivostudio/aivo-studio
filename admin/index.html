<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AIVO Admin</title>
  <link rel="stylesheet" href="./admin.css" />
</head>

<body>
  <header class="top">
    <div class="brand">AIVO <span>Admin</span></div>
    <div class="right" style="display:flex; gap:10px; align-items:center;">
      <span class="muted">Online: <b id="onlineCount">-</b></span>
      <span class="muted">Toplam: <b id="usersTotal">0</b></span>
      <span id="who" class="who"></span>
      <button id="btnCheck" class="btn">Yetki Kontrol</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <h2>Admin EriÅŸimi</h2>
      <p id="authState" class="muted">Kontrol edilmedi.</p>
    </section>

    <section class="grid">
      <div class="card">
        <h3>Kredi Sorgula</h3>
        <div class="row">
          <input id="qEmail" placeholder="email@domain.com" />
          <button id="btnGetCredits" class="btn">Getir</button>
        </div>

        <!-- âœ… EK: SeÃ§ili kullanÄ±cÄ± hÄ±zlÄ± gÃ¶rÃ¼nÃ¼m -->
        <div class="row" style="gap:10px; align-items:center; margin-top:8px; flex-wrap:wrap;">
          <span class="muted">SeÃ§ili:</span>
          <b id="selEmail">â€”</b>
          <span class="muted" style="margin-left:10px;">Kredi:</span>
          <b id="selCredits">â€”</b>
        </div>

        <pre id="creditsOut" class="out"></pre>
      </div>

      <div class="card">
        <h3>Kredi Ayarla</h3>
        <div class="row">
          <input id="aEmail" placeholder="email@domain.com" />
          <input id="aDelta" placeholder="+100 / -50" />
        </div>
        <div class="row">
          <input id="aReason" placeholder="reason (opsiyonel)" />
          <button id="btnAdjust" class="btn btn-primary">Uygula</button>
        </div>
        <pre id="adjustOut" class="out"></pre>
      </div>
    </section>

    <section class="card">
      <h3>SatÄ±n AlÄ±mlar</h3>
      <button id="btnPurchases" class="btn">Listele</button>
      <pre id="pOut" class="out"></pre>
    </section>

    <!-- âœ… YENÄ°: BANLI MAÄ°LLER -->
    <section class="card" id="cardBans">
      <h3 style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <span>BanlÄ± Mailler</span>
        <span class="muted" id="bansStatus">HazÄ±r.</span>
      </h3>

      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <button id="btnBansRefresh" class="btn">Listele</button>
        <input id="bansEmail" placeholder="email@domain.com" style="min-width:220px;" />
        <button id="btnUnban" class="btn btn-primary">Ban KaldÄ±r</button>
      </div>

      <pre id="bansOut" class="out"></pre>

      <p class="muted" style="margin:10px 0 0; opacity:.75;">
        Not: Hard delete iÅŸlemi <code>ban:email</code> yazar. Bu bÃ¶lÃ¼m ban listesini <code>ban_index</code> Ã¼zerinden gÃ¶sterir.
      </p>
    </section>
    <!-- âœ… /BANLI MAÄ°LLER -->

    <!-- ğŸ§¾ ADMIN AUDIT LOG -->
<section class="card" id="cardAudit">
  <h3 style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
    <span>ğŸ§¾ Audit Log</span>
    <span class="muted">Admin iÅŸlemleri</span>
  </h3>

  <div class="row" style="gap:10px; flex-wrap:wrap;">
    <button id="btnAuditList" class="btn">Listele</button>
  </div>

  <pre id="auditOut" class="out"></pre>
</section>
<!-- /ADMIN AUDIT LOG -->

    <!-- ================= KAYITLAR / USERS ================= -->
    <section class="card" id="cardUsers">
      <h3 style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
        <span>KayÄ±tlar (KullanÄ±cÄ±lar)</span>
        <span class="muted" id="usersStatus">HazÄ±r.</span>
      </h3>

      <div class="row" style="gap:10px; flex-wrap:wrap;">
        <button id="btnUsersRefresh" class="btn">Yenile</button>
        <input id="usersSearch" placeholder="email ara..." style="min-width:220px;" />
      </div>

      <div style="overflow:auto; margin-top:10px;">
        <table id="usersTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr style="text-align:left; opacity:.85;">
              <th style="padding:8px 6px;">Email</th>
              <th style="padding:8px 6px;">Role</th>
              <th style="padding:8px 6px;">Created</th>
              <th style="padding:8px 6px;">Updated</th>
              <th style="padding:8px 6px;">Status</th>
              <th style="padding:8px 6px;">Action</th>
            </tr>
          </thead>

          <tbody id="usersTbody">
            <tr>
              <td colspan="6" class="muted" style="padding:10px 6px;">
                HenÃ¼z veri yok.
              </td>
            </tr>
          </tbody>
        </table>
      </div>

           <!-- âœ… kÃ¼Ã§Ã¼k not -->
      <p class="muted" style="margin:10px 0 0; opacity:.75;">
        Ä°pucu: AÅŸaÄŸÄ±daki listede Emailâ€™e tÄ±klayÄ±nca yukarÄ±daki â€œKredi Sorgulaâ€ otomatik dolar ve kredi getirir.
      </p>
    </section>
    <!-- =============== /KAYITLAR ================= -->

    <!-- ğŸš« BanlÄ± Mailler -->
    <section class="card">
      <h3>ğŸš« BanlÄ± Mailler</h3>
      <button id="btnBanList" class="btn">Listele</button>
      <pre id="banOut" class="out"></pre>
    </section>

  </main>

  <script src="./admin.js"></script>

  <!-- âœ… EK: Email tÄ±kla -> qEmail doldur -> kredi getir -->

  <script>
  (function AIVO_ADMIN_EMAIL_CLICK_TO_CREDITS(){
    if (window.__AIVO_ADMIN_EMAIL_CLICK_TO_CREDITS__) return;
    window.__AIVO_ADMIN_EMAIL_CLICK_TO_CREDITS__ = true;

    function $(id){ return document.getElementById(id); }

    var tbody = $("usersTbody");
    var qEmail = $("qEmail");
    var btnGet = $("btnGetCredits");
    var out = $("creditsOut");
    var selEmail = $("selEmail");
    var selCredits = $("selCredits");

    if (!tbody || !qEmail || !out) return;

    function setSelected(email, creditsText){
      try { if (selEmail) selEmail.textContent = email || "â€”"; } catch(e){}
      try { if (selCredits) selCredits.textContent = (creditsText == null ? "â€”" : String(creditsText)); } catch(e){}
    }

    async function fetchCreditsFallback(email){
      var payload = { email: String(email||"").trim() };
      if (!payload.email) return null;

      try {
        var r1 = await fetch("/api/admin/credits/get", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          cache: "no-store",
          body: JSON.stringify(payload)
        });
        if (r1 && r1.ok) {
          var j1 = await r1.json().catch(function(){ return null; });
          return j1;
        }
      } catch(e){}

      try {
        var r2 = await fetch("/api/admin/credits/get?email=" + encodeURIComponent(payload.email), {
          method: "GET",
          credentials: "include",
          cache: "no-store"
        });
        if (r2 && r2.ok) {
          var j2 = await r2.json().catch(function(){ return null; });
          return j2;
        }
      } catch(e){}

      return null;
    }

    function extractCredits(maybeObj){
      if (!maybeObj) return null;
      if (typeof maybeObj.credits === "number") return maybeObj.credits;
      if (typeof maybeObj.credit === "number") return maybeObj.credit;
      if (typeof maybeObj.balance === "number") return maybeObj.balance;
      if (maybeObj.data && typeof maybeObj.data.credits === "number") return maybeObj.data.credits;
      if (maybeObj.data && typeof maybeObj.data.credit === "number") return maybeObj.data.credit;
      return null;
    }

    tbody.addEventListener("click", async function(e){
      try{
        var td = e.target && e.target.closest ? e.target.closest("td") : null;
        if (!td) return;

        var tr = td.closest("tr");
        if (!tr) return;

        var first = tr.querySelector("td");
        if (!first) return;

        var email = (first.textContent || "").trim();
        if (!email || email.indexOf("@") === -1) return;

        qEmail.value = email;
        setSelected(email, "â€¦");

        try { first.style.cursor = "pointer"; } catch(_){}

        var usedButton = false;
        try {
          if (btnGet && typeof btnGet.click === "function") {
            btnGet.click();
            usedButton = true;
          }
        } catch(_){}

        var data = await fetchCreditsFallback(email);

        if (data) {
          var c = extractCredits(data);
          setSelected(email, (c == null ? "?" : c));
          try { out.textContent = JSON.stringify(data, null, 2); } catch(_){}
        } else {
          setSelected(email, usedButton ? "â€¦" : "â€”");
          if (!usedButton) {
            out.textContent = "Kredi sorgulama Ã§aÄŸrÄ±sÄ± yapÄ±lamadÄ± (endpoint yanÄ±tÄ± alÄ±namadÄ±).";
          }
        }
      } catch(err){
        try { out.textContent = "Hata: " + (err && err.message ? err.message : String(err)); } catch(_){}
      }
    }, true);

    try {
      var style = document.createElement("style");
      style.textContent = "#usersTbody td:first-child{cursor:pointer;} #usersTbody td:first-child:hover{ text-decoration: underline; }";
      document.head.appendChild(style);
    } catch(_){}
  })();
  </script>

</body>
</html>

<!-- ADMIN GATE (UI ilk anda gÃ¶rÃ¼nmesin) -->
<style>
  body.is-locked main { display:none !important; }
  body.is-locked .lock-screen{
    max-width:720px; margin:48px auto; padding:18px;
    background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08);
    border-radius:16px;
  }
  body.is-locked .lock-title{ font-weight:800; margin:0 0 8px; }
  body.is-locked .lock-sub{ opacity:.8; margin:0; }

  /* Opsiyonel kÃ¼Ã§Ã¼k gÃ¶rsel iyileÅŸtirme */
  .pill{ display:inline-block; padding:3px 8px; border-radius:999px; font-size:12px; }
  .pill-ok{ background:rgba(0,255,120,.10); border:1px solid rgba(0,255,120,.25); }
  .pill-bad{ background:rgba(255,80,80,.10); border:1px solid rgba(255,80,80,.25); }
  .btn-xs{ padding:6px 10px; font-size:12px; }
  .btn-danger{ background:rgba(255,80,80,.15); border:1px solid rgba(255,80,80,.35); }
</style>

<div class="lock-screen" id="lockScreen" style="display:none;">
  <h2 class="lock-title">EriÅŸim Engellendi</h2>
  <p class="lock-sub" id="lockMsg">Admin yetkin yok veya giriÅŸ bulunamadÄ±.</p>
</div>
