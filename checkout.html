window.addEventListener("error", (e) => {
  document.body.innerHTML = "<pre style='padding:20px;font:14px/1.4 monospace;color:#000'>JS ERROR: " + (e.message || e.error) + "</pre>";
});
window.addEventListener("unhandledrejection", (e) => {
  document.body.innerHTML = "<pre style='padding:20px;font:14px/1.4 monospace;color:#000'>PROMISE ERROR: " + (e.reason || "unknown") + "</pre>";
});

/* ===============================
   AUTH GUARD
   =============================== */
// try {
//   var authed =
//     (sessionStorage.getItem("aivo_auth") === "1") ||
//     (localStorage.getItem("aivo_auth") === "1");
//   if (!authed) {
//     window.location.replace("/index.html");
//     return;
//   }
// } catch (e) {
//   window.location.replace("/index.html");
//   return;
// }

<script>
(function () {
  "use strict";

  /* ===============================
     AUTH GUARD
     =============================== */
  try {
    var authed =
      (sessionStorage.getItem("aivo_auth") === "1") ||
      (localStorage.getItem("aivo_auth") === "1");
    if (!authed) {
      window.location.replace("/index.html");
      return;
    }
  } catch (e) {
    window.location.replace("/index.html");
    return;
  }

  /* ===============================
     HELPERS
     =============================== */
  function setNote(msg) {
    var note = document.getElementById("checkoutNote");
    if (!note) return;
    note.hidden = false;
    note.textContent = msg;
  }

  function hideNote() {
    var note = document.getElementById("checkoutNote");
    if (!note) return;
    note.hidden = true;
    note.textContent = "";
  }

  function parseAmount(x) {
    var s = String(x || "").replace(/[^\d.,]/g, "").replace(",", ".");
    var n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  /* ===============================
     URL PARAMS
     =============================== */
  var params = new URLSearchParams(window.location.search);
  var plan = (params.get("plan") || "").trim();
  var priceRaw = (params.get("price") || "").trim();
  var amount = parseAmount(priceRaw);

  var planEl = document.getElementById("checkoutPlan");
  var priceEl = document.getElementById("checkoutPrice");

  if (planEl) planEl.textContent = plan || "—";
  if (priceEl) priceEl.textContent = amount ? (amount + " ₺") : "—";

  /* ===============================
     BACK BUTTON
     =============================== */
  var backBtn = document.querySelector("[data-checkout-back]");
  if (backBtn) {
    backBtn.addEventListener("click", function () {
      window.history.back();
    });
  }

  /* ===============================
     PAYTR FLOW (ONLY iframe_url MODE)
     =============================== */
  var payBtn = document.getElementById("payBtn");
  var wrap = document.getElementById("paytr-iframe-wrap");
  var iframe = document.getElementById("paytr-iframe");

  if (!payBtn || !wrap || !iframe) return;

  var paying = false;

  payBtn.addEventListener("click", async function () {
    if (paying) return;
    paying = true;

    hideNote();

    var oldText = payBtn.textContent;
    payBtn.disabled = true;
    payBtn.textContent = "Ödeme hazırlanıyor…";
    setNote("Güvenli ödeme ekranı hazırlanıyor…");

    try {
      if (!amount || amount < 1) throw new Error("AMOUNT_INVALID");

      // iframe alanını göster
      wrap.style.display = "block";
      iframe.src = "about:blank";

      var res = await fetch("/api/paytr/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: "user_123",
          email: "test@aivo.tr",
          plan: plan || "Standart Paket",
          amount: Number(amount)
        })
      });

      var data = await res.json().catch(function(){ return null; });

      if (!res.ok || !data || data.ok !== true) {
        var reason = (data && (data.paytr_reason || data.error)) ? (data.paytr_reason || data.error) : ("HTTP_" + res.status);
        setNote("Ödeme başlatılamadı: " + String(reason));
        console.error("[PAYTR_INIT_FAILED]", res.status, data);
        throw new Error("PAYTR_INIT_FAILED");
      }

      if (!data.iframe_url) {
        setNote("Ödeme başlatılamadı: iframe_url gelmedi (init.js get-token dönmüyor).");
        console.error("[PAYTR_INIT_NO_IFRAME_URL]", data);
        throw new Error("PAYTR_INIT_NO_IFRAME_URL");
      }

      // Burada tek iş: iframe_url
      iframe.src = data.iframe_url;

      payBtn.textContent = "Ödeme ekranı açık";
      setNote("Güvenli ödeme ekranı yüklendi.");
      return;

    } catch (err) {
      console.error("[PAYTR_CLICK_ERROR]", err);

      if (String(err && err.message) === "AMOUNT_INVALID") {
        setNote("Tutar geçersiz. Lütfen paketi yeniden seç.");
      } else {
        // üstte reason zaten yazıldı, yine de fallback:
        // setNote("Ödeme başlatılamadı. Lütfen tekrar deneyin.");
      }

      payBtn.disabled = false;
      payBtn.textContent = oldText;
      paying = false;
    }
  });
})();
</script>
