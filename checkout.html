<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIVO Checkout</title>

  <meta name="color-scheme" content="dark" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="/studio.css?v=8" />
  <link rel="stylesheet" href="/checkout.css?v=999" />
</head>

<body>

<main class="checkout-page">
  <div class="checkout-shell">
    <section class="checkout-card">
      <header class="checkout-header">
        <h1 class="checkout-title">Checkout</h1>
        <p class="checkout-desc">Seçtiğin paketi doğrula ve ödemeyi tamamla.</p>
      </header>

      <div class="checkout-summary">
        <div class="checkout-row">
          <span class="checkout-label">Paket</span>
          <strong class="checkout-value" id="checkoutPlan">—</strong>
        </div>

        <div class="checkout-row">
          <span class="checkout-label">Tutar</span>
          <strong class="checkout-value" id="checkoutPrice">—</strong>
        </div>
      </div>

      <div class="checkout-actions">
        <button class="btn btn-ghost" type="button" data-checkout-back>Geri</button>

        <button id="payBtn" class="btn btn-primary" type="button">
          Güvenli Ödeme
        </button>
      </div>

      <p class="checkout-note" id="checkoutNote" hidden></p>

      <!-- PAYTR IFRAME -->
      <div id="paytr-iframe-wrap" style="display:none; margin-top:20px;">
        <iframe
          id="paytr-iframe"
          name="paytriframe"
          src="about:blank"
          frameborder="0"
          scrolling="no"
          style="width:100%; height:650px; border-radius:12px;"
        ></iframe>
      </div>

    </section>
  </div>
</main>

<script>
(function () {
  "use strict";

  /* ===============================
     AUTH GUARD
     =============================== */
  try {
    var authed =
      (sessionStorage.getItem("aivo_auth") === "1") ||
      (localStorage.getItem("aivo_auth") === "1");
    if (!authed) {
      window.location.replace("/index.html");
      return;
    }
  } catch (e) {
    window.location.replace("/index.html");
    return;
  }

  /* ===============================
     HELPERS
     =============================== */
  function setNote(msg) {
    var note = document.getElementById("checkoutNote");
    if (!note) return;
    note.hidden = false;
    note.textContent = msg;
  }

  /* ===============================
     URL PARAMS
     =============================== */
  var params = new URLSearchParams(window.location.search);
  var plan  = (params.get("plan")  || "").trim();
  var price = (params.get("price") || "").trim();

  var planEl  = document.getElementById("checkoutPlan");
  var priceEl = document.getElementById("checkoutPrice");

  if (planEl)  planEl.textContent  = plan  || "—";
  if (priceEl) priceEl.textContent = price ? price + " ₺" : "—";

  /* ===============================
     BACK BUTTON
     =============================== */
  var backBtn = document.querySelector("[data-checkout-back]");
  if (backBtn) {
    backBtn.addEventListener("click", function () {
      window.history.back();
    });
  }

  /* ===============================
     PAYTR FLOW
     =============================== */
  var payBtn = document.getElementById("payBtn");
  if (!payBtn) return;

  var paying = false;

  payBtn.addEventListener("click", async function () {
    if (paying) return;
    paying = true;

    payBtn.disabled = true;
    payBtn.textContent = "Ödeme hazırlanıyor…";
    setNote("Güvenli ödeme ekranı açılıyor…");

    try {
      // 1️⃣ Init
      const res = await fetch("/api/paytr/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: "user_123", // login sisteminden gelecek
          email: "test@aivo.tr",
          plan: plan,
          credits: 0,
          amount: Number(price)
        })
      });

      const data = await res.json();
      if (!data.ok || !data.form) {
        throw new Error("PAYTR_INIT_FAILED");
      }

      // 2️⃣ PayTR form
      const formData = data.form;
      const form = document.createElement("form");
      form.method = "POST";
      form.action = "https://www.paytr.com/odeme";
      form.target = "paytriframe";

      Object.keys(formData).forEach(function (key) {
        var input = document.createElement("input");
        input.type = "hidden";
        input.name = key;
        input.value = formData[key];
        form.appendChild(input);
      });

      document.body.appendChild(form);

      // 3️⃣ Iframe göster
      document.getElementById("paytr-iframe-wrap").style.display = "block";

      // 4️⃣ Submit
      form.submit();

      setTimeout(function () {
        form.remove();
      }, 1000);

    } catch (err) {
      console.error("[PAYTR]", err);
      setNote("Ödeme başlatılamadı. Lütfen tekrar deneyin.");
      payBtn.disabled = false;
      payBtn.textContent = "Güvenli Ödeme";
      paying = false;
    }
  });
})();
</script>

</body>
</html>
