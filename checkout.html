<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIVO Checkout</title>

  <meta name="color-scheme" content="dark" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="/studio.css?v=8" />
  <link rel="stylesheet" href="/checkout.css?v=999" />

  <!-- Stripe (ileride gerçek entegrasyon için) -->
  <script src="https://js.stripe.com/v3/"></script>
</head>

<body>

<main class="checkout-page">
  <div class="checkout-shell">
    <section class="checkout-card">
      <header class="checkout-header">
        <h1 class="checkout-title">Checkout</h1>
        <p class="checkout-desc">Seçtiğin paketi doğrula ve ödemeyi tamamla.</p>
      </header>

      <div class="checkout-summary">
        <div class="checkout-row">
          <span class="checkout-label">Paket</span>
          <strong class="checkout-value" id="checkoutPlan">—</strong>
        </div>

        <div class="checkout-row">
          <span class="checkout-label">Tutar</span>
          <strong class="checkout-value" id="checkoutPrice">—</strong>
        </div>
      </div>

      <div class="checkout-actions">
        <button class="btn btn-ghost" type="button" data-checkout-back>Geri</button>

        <!-- ÖNEMLİ: id="payBtn" şart -->
        <button id="payBtn" class="btn btn-primary" type="button" data-checkout-pay>
          Ödemeye Geç
        </button>
      </div>

      <p class="checkout-note" id="checkoutNote" hidden></p>
    </section>
  </div>
</main>

<script>
/* =========================================================
   CHECKOUT (TEK BLOK / SAFE)
   - URL: /checkout.html?plan=Standart%20Paket&price=399
   - DEMO: kredi + fatura -> aivo_store_v1
   - sonra: /studio.html?page=invoices
   ========================================================= */
(function () {
  "use strict";

  // -----------------------------
  // Helpers
  // -----------------------------
  function setNote(msg) {
    var note = document.getElementById("checkoutNote");
    if (!note) return;
    note.hidden = false;
    note.textContent = msg;
  }

  function safeJsonParse(str, fallback) {
    try { return JSON.parse(str); } catch (e) { return fallback; }
  }

  // -----------------------------
  // URL params -> ekrana yaz
  // -----------------------------
  var params = new URLSearchParams(window.location.search);
  var plan  = (params.get("plan")  || "").trim();
  var price = (params.get("price") || "").trim();

  var planEl  = document.getElementById("checkoutPlan");
  var priceEl = document.getElementById("checkoutPrice");
  if (planEl)  planEl.textContent  = plan  ? plan  : "—";
  if (priceEl) priceEl.textContent = price ? price : "—";

  // -----------------------------
  // Back button
  // -----------------------------
  var backBtn = document.querySelector("[data-checkout-back]");
  if (backBtn) {
    backBtn.addEventListener("click", function () {
      window.history.back();
    });
  }

  // -----------------------------
  // Pay button
  // -----------------------------
  var payBtn = document.getElementById("payBtn");
  if (!payBtn) return;

  var paying = false;

  payBtn.addEventListener("click", function () {
    if (paying) return;
    paying = true;

    var oldText = payBtn.textContent;
    payBtn.disabled = true;
    payBtn.textContent = "İşleniyor…";

    try {
      // -------------------------------------------------------
      // DEMO SUCCESS (tek store)
      // -------------------------------------------------------
      setNote("Demo ödeme başarılı. Kredi ve fatura ekleniyor…");

    var creditsAdded = (
  /studio/i.test(plan) ? 1500 :
  /pro/i.test(plan) ? 500 :
  /(standart|standard)/i.test(plan) ? 300 :
  /(starter|baslangic|başlangıç)/i.test(plan) ? 100 :
  100
);


      // TEK STORE
      var STORE_KEY = "aivo_store_v1";
      var base = { credits: 0, invoices: [] };
      var store = safeJsonParse(localStorage.getItem(STORE_KEY) || "", base);

      if (!store || typeof store !== "object") store = base;
      if (typeof store.credits !== "number") store.credits = Number(store.credits || 0);
      if (!Array.isArray(store.invoices)) store.invoices = [];

      store.credits = store.credits + creditsAdded;

      store.invoices.unshift({
        id: "INV-" + Date.now(),
        createdAt: Date.now(),
        title: "Kredi Satın Alma",
        plan: plan || "—",
        price: price || "—",
        creditsAdded: creditsAdded,
        status: "paid"
      });

      localStorage.setItem(STORE_KEY, JSON.stringify(store));

      // -------------------------------------------------------
      // Invoices'a git
      // -------------------------------------------------------
      window.location.href = "/studio.html?page=invoices&v=" + Date.now();
      return;

    } catch (err) {
      console.error(err);
      setNote("Mock ödeme başarısız. Tekrar deneyin.");
      payBtn.disabled = false;
      payBtn.textContent = oldText;
      paying = false;
    }
  });
})();
<script>
/* =========================================================
   STRIPE INIT (SADECE CHECKOUT SAYFASI)
   ========================================================= */

// ⚠️ Stripe Dashboard → Publishable Key (pk_test_... veya pk_live_...)
var stripe = Stripe("pk_test_Xxxxxxxxxxxxxxxxx"); 
</script>

<script>
/* =========================================================
   CHECKOUT (TEK BLOK / PROD-READY)
   ========================================================= */
(function () {
  "use strict";

  function setNote(msg) {
    var note = document.getElementById("checkoutNote");
    if (!note) return;
    note.hidden = false;
    note.textContent = msg;
  }

  var params = new URLSearchParams(window.location.search);
  var plan  = (params.get("plan")  || "").trim();
  var price = (params.get("price") || "").trim();

  var planEl  = document.getElementById("checkoutPlan");
  var priceEl = document.getElementById("checkoutPrice");
  if (planEl)  planEl.textContent  = plan  || "—";
  if (priceEl) priceEl.textContent = price || "—";

  var backBtn = document.querySelector("[data-checkout-back]");
  if (backBtn) backBtn.onclick = () => history.back();

  var payBtn = document.getElementById("payBtn");
  if (!payBtn) return;

  var paying = false;

  payBtn.addEventListener("click", async function () {
    if (paying) return;
    paying = true;

    payBtn.disabled = true;
    payBtn.textContent = "Stripe'a yönlendiriliyor…";
    setNote("Ödeme sayfası hazırlanıyor…");

    try {
      const res = await fetch("/api/stripe/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          plan: plan,
          price: price
        })
      });

      if (!res.ok) throw new Error("Session oluşturulamadı");

      const data = await res.json();
      if (!data.sessionId) throw new Error("sessionId gelmedi");

      const result = await stripe.redirectToCheckout({
        sessionId: data.sessionId
      });

      if (result.error) throw new Error(result.error.message);

    } catch (err) {
      console.error(err);
      setNote("Ödeme başlatılamadı. Lütfen tekrar deneyin.");
      payBtn.disabled = false;
      payBtn.textContent = "Ödemeye Geç";
      paying = false;
    }
  });
})();
</script>

<!-- studio.js SADECE render + kredi + fatura içindir -->
<script src="/studio.js?v=999"></script>
<script>
  (function () {
    try {
      if (localStorage.getItem("aivo_auth") !== "1") {
        window.location.replace("/login");
      }
    } catch (e) {
      window.location.replace("/login");
    }
  })();
</script>

</body>
</html>
