<script>
(function () {
  "use strict";

  // -----------------------------
  // AUTH GUARD
  // -----------------------------
  try {
    var authed =
      (sessionStorage.getItem("aivo_auth") === "1") ||
      (localStorage.getItem("aivo_auth") === "1");
    if (!authed) {
      window.location.replace("/index.html");
      return;
    }
  } catch (e) {
    window.location.replace("/index.html");
    return;
  }

  // -----------------------------
  // HELPERS
  // -----------------------------
  function setNote(msg) {
    var note = document.getElementById("checkoutNote");
    if (!note) return;
    note.hidden = false;
    note.textContent = msg;
  }

  function onlyNumberPrice(x) {
    // "399 ₺" / "399" / "399.00" -> 399
    var s = String(x || "").replace(/[^\d.,]/g, "").replace(",", ".");
    var n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  // -----------------------------
  // URL PARAMS
  // -----------------------------
  var params = new URLSearchParams(window.location.search);
  var plan = (params.get("plan") || "").trim();
  var priceRaw = (params.get("price") || "").trim();
  var amount = onlyNumberPrice(priceRaw);

  var planEl = document.getElementById("checkoutPlan");
  var priceEl = document.getElementById("checkoutPrice");
  if (planEl) planEl.textContent = plan || "—";
  if (priceEl) priceEl.textContent = amount ? (amount + " ₺") : "—";

  // -----------------------------
  // BACK BUTTON
  // -----------------------------
  var backBtn = document.querySelector("[data-checkout-back]");
  if (backBtn) {
    backBtn.addEventListener("click", function () {
      window.history.back();
    });
  }

  // -----------------------------
  // PAYTR FLOW
  // -----------------------------
  var payBtn = document.getElementById("payBtn");
  if (!payBtn) return;

  var paying = false;

  payBtn.addEventListener("click", async function () {
    if (paying) return;
    paying = true;

    payBtn.disabled = true;
    var oldText = payBtn.textContent;
    payBtn.textContent = "Ödeme hazırlanıyor…";
    setNote("Güvenli ödeme ekranı açılıyor…");

    try {
      if (!amount || amount < 1) throw new Error("AMOUNT_INVALID");

      // 1) init çağır
      var res = await fetch("/api/paytr/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: "user_123", // login sisteminden gelecek
          email: "test@aivo.tr",
          plan: plan || "Standart Paket",
          credits: 0,
          amount: amount
        })
      });

      var data = await res.json().catch(function(){ return null; });
      if (!res.ok || !data || !data.ok || !data.form) {
        console.error("[PAYTR_INIT_RESPONSE]", res.status, data);
        throw new Error("PAYTR_INIT_FAILED");
      }

      // 2) PayTR form post (iframe target)
      var formData = data.form;
      var form = document.createElement("form");
      form.method = "POST";
      form.action = "https://www.paytr.com/odeme";
      form.target = "paytriframe";

      Object.keys(formData).forEach(function (key) {
        var input = document.createElement("input");
        input.type = "hidden";
        input.name = key;
        input.value = String(formData[key]);
        form.appendChild(input);
      });

      document.body.appendChild(form);

      // 3) iframe göster
      var wrap = document.getElementById("paytr-iframe-wrap");
      if (wrap) wrap.style.display = "block";

      // 4) submit
      form.submit();

      // temizlik
      setTimeout(function () {
        try { form.remove(); } catch (e) {}
      }, 1000);

      // butonu pasif bırakıyoruz (kullanıcı tekrar basmasın)
      payBtn.textContent = "Ödeme ekranı açık";
      return;

    } catch (err) {
      console.error("[PAYTR_CLICK_ERROR]", err);
      setNote("Ödeme başlatılamadı. Lütfen tekrar deneyin.");
      payBtn.disabled = false;
      payBtn.textContent = oldText;
      paying = false;
    }
  });
})();
</script>
