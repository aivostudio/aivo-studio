<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIVO Checkout</title>

  <meta name="color-scheme" content="dark" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="/studio.css?v=8" />
  <link rel="stylesheet" href="/checkout.css?v=999" />

  <script src="https://js.stripe.com/v3/"></script>


</head>

<body>

<main class="checkout-page">
  <div class="checkout-shell">
    <section class="checkout-card">
      <header class="checkout-header">
        <h1 class="checkout-title">Checkout</h1>
        <p class="checkout-desc">Seçtiğin paketi doğrula ve ödemeyi tamamla.</p>
      </header>

      <div class="checkout-summary">
        <div class="checkout-row">
          <span class="checkout-label">Paket</span>
          <strong class="checkout-value" id="checkoutPlan">—</strong>
        </div>

        <div class="checkout-row">
          <span class="checkout-label">Tutar</span>
          <strong class="checkout-value" id="checkoutPrice">—</strong>
        </div>
      </div>

      <div class="checkout-actions">
        <button class="btn btn-ghost" type="button" data-checkout-back>Geri</button>
        <button class="btn btn-primary" type="button" data-checkout-pay>
          Ödemeye Geç
        </button>
      </div>

      <p class="checkout-note" id="checkoutNote" hidden></p>
    </section>
  </div>
</main>

<script>
(function () {
  /* ===============================
stripe ================= */
  var stripe = Stripe("pk_test_REPLACE_ME"); // <-- DEĞİŞTİR

  /* ================= URL params ================= */
  var params = new URLSearchParams(window.location.search);
  var plan  = params.get("plan")  || "—";
  var price = params.get("price") || "—";

  var planEl  = document.getElementById("checkoutPlan");
  var priceEl = document.getElementById("checkoutPrice");
  if (planEl)  planEl.textContent  = plan;
  if (priceEl) priceEl.textContent = price;

  /* ================= helpers ================= */
  function closest(el, sel) {
    if (!el) return null;
    if (el.closest) return el.closest(sel);
    while (el && el.nodeType === 1) {
      if (el.matches && el.matches(sel)) return el;
      el = el.parentElement;
    }
    return null;
  }

  /* ================= actions ================= */
  var paying = false;

  document.addEventListener("click", async function (e) {
    var backBtn = closest(e.target, "[data-checkout-back]");
    if (backBtn) {
      e.preventDefault();
      window.history.back();
      return;
    }

    var payBtn = closest(e.target, "[data-checkout-pay]");
    if (!payBtn) return;

    e.preventDefault();
    if (paying) return;
    paying = true;

    var oldText = payBtn.textContent;
    payBtn.disabled = true;
    payBtn.textContent = "Yönlendiriliyor...";

    var note = document.getElementById("checkoutNote");
    if (note) {
      note.hidden = false;
      note.textContent = "Stripe oturumu hazırlanıyor...";
    }

    try {
      const res = await fetch("/api/stripe/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ plan: plan })
      });

      if (!res.ok) throw new Error("Session oluşturulamadı");
      const data = await res.json();
      if (!data.sessionId) throw new Error("sessionId gelmedi");

     const result = await stripe.redirectToCheckout({
          sessionId: data.sessionId
        });

        if (result && result.error) {
          throw new Error(result.error.message);
        }

        // redirect başarılıysa zaten sayfa değişecek; aşağısı normalde çalışmaz
        return;
      }

      // -------------------------------------------------------
      // 2) Stripe yok / session yok / endpoint yok -> DEMO SUCCESS
      // -------------------------------------------------------
      const creditsAdded = 100;

      addDemoCredits(creditsAdded);

      saveDemoInvoice({
        id: "inv_" + Date.now(),
        paymentId: "pay_" + Date.now(),
        plan: "Test Paket",
        price: 123,
        credits: creditsAdded,
        date: new Date().toISOString()
      });

      window.location.href = "/studio.html?page=invoices&v=" + Date.now();
      return;

    } catch (err) {
      console.error(err);
      setNote("Ödeme entegrasyonu (Stripe/iyzico) bir sonraki adımda bağlanacak.");
      payBtn.disabled = false;
      payBtn.textContent = oldText;
      paying = false;
      return;
<script>
/* =========================================================
   CHECKOUT — URL'den Plan / Price Oku + DEMO ÖDEME
   SAFE / INLINE / KARMAŞA YOK
   ========================================================= */

(function () {
  // -------------------------------------------------------
  // 1) URL'den plan & price oku
  // /checkout.html?plan=Test%20Paket&price=123
  // -------------------------------------------------------
  var params = new URLSearchParams(window.location.search);

  var plan =
    (params.get("plan") ||
     params.get("paket") ||
     "").trim();

  var price =
    (params.get("price") ||
     params.get("tutar") ||
     "").trim();

  var planEl = document.getElementById("checkoutPlan");
  var priceEl = document.getElementById("checkoutPrice");

 if (planEl) planEl.textContent = plan ? plan : "--";

  if (priceEl) priceEl.textContent = price || "—";

  // global (demo ödeme için)
  window.__checkoutPlan = plan;
  window.__checkoutPrice = Number(price || 0);
<script>
(function () {
  // -------------------------------------------------------
  // 1) URL -> Plan / Price doldur + global'e yaz
  // örnek: /checkout.html?plan=Test%20Paket&price=123
  // -------------------------------------------------------
  var params = new URLSearchParams(window.location.search);

  var plan = (params.get("plan") || "").trim();
  var priceRaw = (params.get("price") || "").trim();
  var priceNum = Number(priceRaw);

  // ekranda görünen alanlar (HTML'de id'ler bunlar olmalı)
  var planEl = document.getElementById("checkoutPlan");
  var priceEl = document.getElementById("checkoutPrice");

  if (planEl) planEl.textContent = plan ? plan : "—";
  if (priceEl) priceEl.textContent = (isFinite(priceNum) && priceRaw !== "") ? String(priceNum) : "—";

  // DEMO ödeme için global
  window.__checkoutPlan = plan ? plan : "—";
  window.__checkoutPrice = (isFinite(priceNum) && priceRaw !== "") ? priceNum : 0;

  // -------------------------------------------------------
  // 2) DEMO ödeme butonu (kredi + fatura + yönlendirme)
  // -------------------------------------------------------
  var payBtn = document.getElementById("payBtn");
  var note = document.getElementById("checkoutNote");
  var paying = false;

  // payBtn yoksa sessizce çık (sayfa kırılmasın)
  if (!payBtn) return;

  payBtn.addEventListener("click", function () {
    if (paying) return;
    paying = true;

    var oldText = payBtn.textContent;
    payBtn.disabled = true;
    payBtn.textContent = "İşleniyor…";

    try {
      // ---- DEMO kredi ----
      var creditsAdded = 100;

      var currentCredits = Number(localStorage.getItem("aivo_credits") || 0);
      localStorage.setItem("aivo_credits", String(currentCredits + creditsAdded));

      // ---- DEMO fatura ----
      var invoices = JSON.parse(localStorage.getItem("aivo_invoices") || "[]");

      invoices.push({
        id: "inv_" + Date.now(),
        paymentId: "pay_" + Date.now(),
        plan: window.__checkoutPlan || "—",
        price: window.__checkoutPrice || 0,
        credits: creditsAdded,
        date: new Date().toISOString()
      });

      localStorage.setItem("aivo_invoices", JSON.stringify(invoices));

      // ---- yönlendirme (Faturalarım) ----
      window.location.href = "/studio.html?page=invoices&v=" + Date.now();
      return;

    } catch (err) {
      console.error(err);
      if (note) {
        note.textContent =
          "Ödeme entegrasyonu (Stripe/iyzico) bir sonraki adımda bağlanacak.";
      }
      payBtn.disabled = false;
      payBtn.textContent = oldText;
      paying = false;
    }
  });
})();
</script>
<script src="/studio.js?v=999"></script>

<!-- <script src="/checkout.js"></script> -->
</body>
</html>
