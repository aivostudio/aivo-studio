<script>
(function () {
  "use strict";

  /* ================= UI HELPERS ================= */

  function setNote(msg) {
    const el = document.getElementById("checkoutNote");
    if (!el) return;
    el.hidden = false;
    el.textContent = msg;
  }

  function parseAmount(x) {
    const s = String(x || "").replace(/[^\d.,]/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  /* ================= URL PARAMS (DISPLAY ONLY) ================= */

  const params = new URLSearchParams(location.search);

  const plan  = (params.get("plan") || "").trim();
  const price = parseAmount(params.get("price"));

  const planEl  = document.getElementById("checkoutPlan");
  const priceEl = document.getElementById("checkoutPrice");

  if (planEl)  planEl.textContent  = plan || "—";
  if (priceEl) priceEl.textContent = price ? `${price} ₺` : "—";

  const backBtn = document.querySelector("[data-checkout-back]");
  if (backBtn) backBtn.onclick = () => history.back();

  /* ================= PAYTR INIT ================= */

  const payBtn = document.getElementById("payBtn");
  let paying = false;

  if (payBtn) payBtn.addEventListener("click", async function () {
    if (paying) return;
    paying = true;

    payBtn.disabled = true;
    payBtn.textContent = "Ödeme hazırlanıyor…";
    setNote("Ödeme hazırlanıyor…");

    try {
      if (!price || price < 1) throw new Error("AMOUNT_INVALID");

      const r = await fetch("/api/paytr/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: "demo_user_1",
          email: "test@aivo.tr",
          plan: plan || "Paket",
          amount: price
        })
      });

      const data = await r.json();
      if (!r.ok || !data || !data.ok || !data.form) {
        throw new Error("PAYTR_INIT_FAILED");
      }

      const wrap = document.getElementById("paytr-iframe-wrap");
      if (wrap) wrap.style.display = "block";

      const form = document.createElement("form");
      form.method = "POST";
      form.action = "https://www.paytr.com/odeme";
      form.target = "paytriframe";

      Object.entries(data.form).forEach(([k, v]) => {
        if (v == null) return;
        const i = document.createElement("input");
        i.type = "hidden";
        i.name = k;
        i.value = String(v);
        form.appendChild(i);
      });

      document.body.appendChild(form);
      form.submit();

      setTimeout(() => form.remove(), 1000);
      setNote("Güvenli ödeme ekranı açıldı.");

    } catch (e) {
      console.error(e);
      setNote("Ödeme başlatılamadı.");
      payBtn.disabled = false;
      payBtn.textContent = "Güvenli Ödeme";
      paying = false;
    }
  });
})();
</script>

<script>
/* =========================================================
   STRIPE SUCCESS → VERIFY → APPLY CREDITS
   ========================================================= */
(async function () {
  try {
    const qs = new URLSearchParams(location.search);
    if (qs.get("status") !== "success") return;

    const sessionId = qs.get("session_id");
    if (!sessionId) return;

    const r = await fetch(`/api/stripe/verify-session?session_id=${encodeURIComponent(sessionId)}`);
    const data = await r.json();
    if (!data || !data.ok || !data.paid) return;

    if (!window.AIVO_STORE_V1) return;

    const res = window.AIVO_STORE_V1.applyPurchase({
      order_id: data.order_id || data.session_id,
      pack: data.pack,
      credits: data.credits
    });

    if (res?.ok && window.showToast) {
      showToast(`+${res.added} kredi yüklendi`, "ok");
    }

    // URL temizle
    const clean = new URL(location.href);
    clean.search = "";
    history.replaceState({}, "", clean.toString());

  } catch (e) {
    console.error("Stripe apply error:", e);
  }
})();
</script>

</body>
</html>
