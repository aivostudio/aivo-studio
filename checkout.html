<script>
(function () {
  "use strict";

  /* ================= UI HELPERS ================= */

  function setNote(msg) {
    const el = document.getElementById("checkoutNote");
    if (!el) return;
    el.hidden = false;
    el.textContent = msg;
  }

  function parseAmount(x) {
    const s = String(x || "").replace(/[^\d.,]/g, "").replace(",", ".");
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function safeGetSelectedPack() {
    try {
      if (window.AIVO_STORE_V1 && typeof window.AIVO_STORE_V1.getSelectedPack === "function") {
        const p = window.AIVO_STORE_V1.getSelectedPack();
        return p ? String(p) : "";
      }
    } catch (e) {}
    return "";
  }

  function resolvePayTREnabledFlag() {
    let enabled = false;
    try {
      const url = new URL(window.location.href);

      // query override (?paytr=1 | ?paytr=0)
      if (url.searchParams.has("paytr")) {
        const q = url.searchParams.get("paytr");
        if (q === "1") localStorage.setItem("AIVO_PAYTR_ENABLED", "1");
        if (q === "0") localStorage.setItem("AIVO_PAYTR_ENABLED", "0");

        url.searchParams.delete("paytr");
        history.replaceState({}, "", url.pathname);
      }

      enabled = localStorage.getItem("AIVO_PAYTR_ENABLED") === "1";
    } catch (e) {}

    console.log("[PayTR][FLAG]", enabled ? "ENABLED" : "DISABLED");
    return enabled;
  }

  /* ================= DISPLAY ================= */

  const params = new URLSearchParams(location.search);
  const storePack = safeGetSelectedPack();

  const urlPlan  = (params.get("plan") || "").trim();
  const urlPrice = parseAmount(params.get("price"));

  const planEl  = document.getElementById("checkoutPlan");
  const priceEl = document.getElementById("checkoutPrice");

  const displayPrice = storePack ? parseAmount(storePack) : urlPrice;
  const displayPlan  = urlPlan || "Paket";

  if (planEl)  planEl.textContent  = displayPlan;
  if (priceEl) priceEl.textContent = displayPrice ? `${displayPrice} ₺` : "—";

  const backBtn = document.querySelector("[data-checkout-back]");
  if (backBtn) backBtn.onclick = () => history.back();

  /* ================= CHECKOUT BUTTON ================= */

  const payBtn = document.getElementById("payBtn");
  if (!payBtn) return;

  let paying = false;
  if (payBtn.dataset.bound === "1") return;
  payBtn.dataset.bound = "1";

  payBtn.addEventListener("click", async function () {
    if (paying) return;
    paying = true;

    payBtn.disabled = true;
    payBtn.textContent = "Ödeme hazırlanıyor…";
    setNote("Ödeme hazırlanıyor…");

    try {
      const PAYTR_ENABLED = resolvePayTREnabledFlag();
      const amount = displayPrice;

      // Store varsa pack oradan, yoksa amount’tan türet
      let pack = (storePack || "").trim();
      if (!pack) pack = String(Math.round(amount || 0));

      // Allowed liste
      const ALLOWED = ["199","399","899","2999"];
      if (!ALLOWED.includes(pack)) {
        throw new Error("INVALID_PACK:" + pack + " amount=" + amount);
      }

      /* ================= STRIPE (TEST MODE) ================= */

      if (!PAYTR_ENABLED) {
        console.log("[Checkout] Stripe plan =", pack);
        setNote("Stripe plan: " + pack);

        const r = await fetch("/api/stripe/create-checkout-session", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            plan: pack,
            pack: pack,
            price: pack
          })
        });

        // JSON değilse bile gerçek cevabı görebilmek için:
        const raw = await r.text();
        let data = null;
        try { data = JSON.parse(raw); } catch (_) {}

        if (!r.ok || !data || !data.url) {
          const errMsg =
            (data && data.error) ? data.error :
            ("STRIPE_INIT_FAILED HTTP " + r.status + " RAW=" + raw.slice(0, 160));
          throw new Error(errMsg);
        }

        // ✅ KRİTİK: Studio finalizer için session_id sakla
        // (Studio açılınca aivo_pending_stripe_session okunacak → verify-session tetiklenecek)
        if (data.session_id) {
          try { localStorage.setItem("aivo_pending_stripe_session", String(data.session_id)); } catch (e) {}
        } else {
          // session_id yoksa bu zaten backend bug demektir; yine de daha net log bırakalım
          console.warn("[Checkout] session_id missing in response:", data);
        }

        setNote("Stripe yönlendirmesi başlatılıyor…");
        window.location.href = data.url;
        return;
      }

      /* ================= PAYTR (LATER) ================= */

      throw new Error("PAYTR_NOT_ACTIVE");

    } catch (err) {
      console.error("[Checkout]", err);

      setNote("Checkout başarısız: " + (err && err.message ? err.message : "Bilinmeyen hata"));

      payBtn.disabled = false;
      payBtn.textContent = "Güvenli Ödeme";
      paying = false;
    }
  });
})();
</script>

<!-- =========================================================
     NOT: Aşağıdaki eski blok ARTIK KULLANILMAYACAK.
     Çünkü dönüş URL’sinde status/session_id query yok.
     Tek otorite: Studio tarafındaki localStorage finalizer.
========================================================== -->
<!--
<script>
(async function () {
  try {
    const qs = new URLSearchParams(location.search);
    if (qs.get("status") !== "success") return;

    const sessionId = qs.get("session_id");
    if (!sessionId) return;

    const r = await fetch(`/api/stripe/verify-session?session_id=${encodeURIComponent(sessionId)}`);
    const data = await r.json().catch(() => null);
    if (!data || !data.ok) return;

    if (!window.AIVO_STORE_V1 || typeof window.AIVO_STORE_V1.applyPurchase !== "function") return;

    const res = window.AIVO_STORE_V1.applyPurchase({
      order_id: data.order_id || data.session_id,
      pack: data.pack,
      credits: data.credits
    });

    if (res?.ok && typeof window.showToast === "function") {
      window.showToast(`+${res.added} kredi yüklendi`, "ok");
    }

    const clean = new URL(location.href);
    clean.search = "";
    history.replaceState({}, "", clean.toString());
  } catch (e) {
    console.error("Stripe apply error:", e);
  }
})();
</script>
-->
