<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AIVO Checkout</title>

  <meta name="color-scheme" content="dark" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />

  <link rel="stylesheet" href="/studio.css?v=8" />
  <link rel="stylesheet" href="/checkout.css?v=999" />
</head>

<body>

<main class="checkout-page">
  <div class="checkout-shell">
    <section class="checkout-card">

      <header class="checkout-header">
        <h1 class="checkout-title">Checkout</h1>
        <p class="checkout-desc">Seçtiğin paketi doğrula ve ödemeyi tamamla.</p>
      </header>

      <div class="checkout-summary">
        <div class="checkout-row">
          <span class="checkout-label">Paket</span>
          <strong class="checkout-value" id="checkoutPlan">—</strong>
        </div>
        <div class="checkout-row">
          <span class="checkout-label">Tutar</span>
          <strong class="checkout-value" id="checkoutPrice">—</strong>
        </div>
      </div>

      <div class="checkout-actions">
        <button class="btn btn-ghost" type="button" id="backBtn">Geri</button>
        <button class="btn btn-primary" type="button" id="payBtn">Güvenli Ödeme</button>
      </div>

      <p class="checkout-note" id="checkoutNote" hidden></p>

      <!-- PAYTR IFRAME -->
      <div id="paytr-iframe-wrap" style="display:none; margin-top:20px;">
        <iframe
          id="paytr-iframe"
          name="paytriframe"
          src="about:blank"
          frameborder="0"
          scrolling="no"
          style="width:100%; height:650px; border-radius:12px;"
        ></iframe>
      </div>

    </section>
  </div>
</main>

<script>
(function () {
  "use strict";

  /* ===============================
     HATA YAKALAMA (DEBUG)
     =============================== */
  window.addEventListener("error", function (e) {
    showNote("JS ERROR: " + (e.message || "unknown"));
  });
  window.addEventListener("unhandledrejection", function (e) {
    showNote("PROMISE ERROR: " + (e.reason || "unknown"));
  });

  /* ===============================
     AUTH GUARD (ŞİMDİLİK KAPALI)
     =============================== */
  // BİLEREK YORUMDA – TEST BİTİNCE GERİ AÇACAĞIZ

  /* ===============================
     HELPERS
     =============================== */
  function showNote(msg) {
    var n = document.getElementById("checkoutNote");
    if (!n) return;
    n.hidden = false;
    n.textContent = msg;
  }

  function hideNote() {
    var n = document.getElementById("checkoutNote");
    if (!n) return;
    n.hidden = true;
    n.textContent = "";
  }

  function parseAmount(x) {
    var s = String(x || "").replace(/[^\d.,]/g, "").replace(",", ".");
    var n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function pick(obj, keys) {
    var out = {};
    keys.forEach(function (k) {
      if (obj && obj[k] != null) out[k] = obj[k];
    });
    return out;
  }

  function missingKeys(obj, keys) {
    return keys.filter(function (k) {
      return !obj || obj[k] == null || String(obj[k]).trim() === "";
    });
  }

  /* ===============================
     URL PARAMS
     =============================== */
  var params = new URLSearchParams(window.location.search);
  var plan = (params.get("plan") || "").trim();
  var priceRaw = (params.get("price") || "").trim();
  var amount = parseAmount(priceRaw);

  document.getElementById("checkoutPlan").textContent = plan || "—";
  document.getElementById("checkoutPrice").textContent = amount ? amount + " ₺" : "—";

  /* ===============================
     BACK
     =============================== */
  document.getElementById("backBtn").onclick = function () {
    history.back();
  };

  /* ===============================
     PAYTR – FORM SUBMIT → IFRAME
     =============================== */
  var payBtn = document.getElementById("payBtn");
  var wrap = document.getElementById("paytr-iframe-wrap");
  var iframe = document.getElementById("paytr-iframe");

  var paying = false;

  payBtn.onclick = async function () {
    if (paying) return;
    paying = true;

    hideNote();
    payBtn.disabled = true;
    payBtn.textContent = "Ödeme hazırlanıyor…";
    showNote("Güvenli ödeme ekranı hazırlanıyor…");

    try {
      if (!amount || amount <= 0) throw new Error("AMOUNT_INVALID");

      wrap.style.display = "block";
      iframe.src = "about:blank";

      const res = await fetch("/api/paytr/init", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: "user_123",
          email: "test@aivo.tr",
          plan: plan || "Standart Paket",
          amount: amount
        })
      });

      const data = await res.json();

      if (!res.ok || !data || data.ok !== true || !data.form) {
        showNote("Ödeme başlatılamadı: " + (data?.detail || data?.error || "init failed"));
        throw new Error("INIT_FAILED");
      }

      const ALLOWED = [
        "merchant_id",
        "user_ip",
        "merchant_oid",
        "email",
        "payment_amount",
        "currency",
        "user_basket",
        "no_installment",
        "max_installment",
        "installment_count",
        "merchant_ok_url",
        "merchant_fail_url",
        "timeout_limit",
        "debug_on",
        "test_mode",
        "lang",
        "paytr_token"
      ];

      const REQUIRED = [
        "merchant_id",
        "user_ip",
        "merchant_oid",
        "email",
        "payment_amount",
        "user_basket",
        "paytr_token"
      ];

      const formData = pick(data.form, ALLOWED);
      const miss = missingKeys(formData, REQUIRED);
      if (miss.length) {
        showNote("Eksik PayTR alanları: " + miss.join(", "));
        throw new Error("MISSING_FIELDS");
      }

      const form = document.createElement("form");
      form.method = "POST";
      form.action = "https://www.paytr.com/odeme";
      form.target = "paytriframe";

      Object.keys(formData).forEach(function (k) {
        const i = document.createElement("input");
        i.type = "hidden";
        i.name = k;
        i.value = String(formData[k]);
        form.appendChild(i);
      });

      document.body.appendChild(form);
      form.submit();

      setTimeout(function () { form.remove(); }, 1000);

      payBtn.textContent = "Ödeme ekranı açık";
      showNote("Güvenli ödeme ekranı yüklendi.");

    } catch (e) {
      console.error(e);
      payBtn.disabled = false;
      payBtn.textContent = "Güvenli Ödeme";
      paying = false;
    }
  };

})();
</script>

</body>
</html>
